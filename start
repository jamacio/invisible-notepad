#!/bin/bash

echo "ğŸ§ Invisible Notepad - Setup and Launch"
echo "======================================"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸ“ Working directory: $SCRIPT_DIR"
echo ""

# Check if Node.js and npm are available
if ! command -v node &> /dev/null; then
    echo "âŒ Node.js is required but not installed."
    echo "   Please install Node.js first:"
    echo "   Ubuntu/Debian: sudo apt install nodejs npm"
    echo "   Fedora: sudo dnf install nodejs npm"
    echo "   Arch: sudo pacman -S nodejs npm"
    exit 1
fi

if ! command -v npm &> /dev/null; then
    echo "âŒ npm is required but not installed."
    echo "   Please install npm first."
    exit 1
fi

echo "âœ… Node.js: $(node --version)"
echo "âœ… npm: $(npm --version)"

# Check for optional dependencies
if ! command -v xdotool &> /dev/null; then
    echo "âš ï¸  xdotool not found (recommended for better functionality)"
    echo "   Install with: sudo apt install xdotool"
else
    echo "âœ… xdotool: available"
fi

echo ""

# Install npm dependencies if needed
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing project dependencies..."
    npm install
    if [ $? -ne 0 ]; then
        echo "âŒ Failed to install dependencies!"
        exit 1
    fi
    echo "âœ… Dependencies installed!"
else
    echo "âœ… Dependencies already installed"
fi

echo ""

# Create desktop entry
echo "ğŸ–¥ï¸  Creating/updating desktop menu entry..."
DESKTOP_FILE="$HOME/.local/share/applications/invisible-notepad.desktop"
mkdir -p "$HOME/.local/share/applications"

cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Version=1.0
Type=Application
Name=Invisible Notepad
Comment=Teleprompter for presentations - invisible during screen sharing
Exec=bash $SCRIPT_DIR/iniciar-linux.sh
Icon=utilities-text-editor
Terminal=false
Categories=Office;Utility;TextEditor;
Keywords=teleprompter;notes;presentation;invisible;screen-sharing;
StartupNotify=true
StartupWMClass=invisible-notepad
EOF

chmod +x "$DESKTOP_FILE"
echo "âœ… Desktop entry created/updated"

echo ""
echo "ğŸš€ Starting Invisible Notepad..."
echo ""
echo "ğŸ“º HOW TO USE AS TELEPROMPTER:"
echo "  1. Type your notes in the editor"
echo "  2. Start your video conference (Teams, Meet, Zoom, etc.)"
echo "  3. Share your screen"
echo "  4. Press Ctrl+I to activate teleprompter mode"
echo "  5. Your notes stay visible to you, invisible to others!"
echo ""
echo "âŒ¨ï¸  SHORTCUTS:"
echo "  Ctrl+I = Teleprompter ON/OFF"
echo "  Ctrl+Alt+H = Hide/show window"
echo ""

# Cria um arquivo de log
LOG_FILE="/tmp/invisible-notepad.log"

echo "âœ… Starting app in background..."
echo "ğŸ“‹ Log file: $LOG_FILE"

# Inicia o aplicativo em background usando nohup
# O app continuarÃ¡ rodando mesmo se o terminal for fechado
nohup npm start > "$LOG_FILE" 2>&1 &

# ObtÃ©m o PID do processo
APP_PID=$!

echo "ğŸ“ App started with PID: $APP_PID"
echo ""

# Aguarda um momento para o app inicializar
sleep 3

# Verifica se o processo ainda estÃ¡ rodando
if ps -p "$APP_PID" > /dev/null 2>&1; then
    echo "âœ… App is running successfully in background!"
    echo "ğŸ”“ Terminal remains open - you can close it safely"
    echo "ğŸ“± The app will continue running even if you close this terminal"
    echo ""
    echo "To stop the app later, run:"
    echo "pkill -f 'npm start'"
    echo ""
    echo "To check if the app is still running:"
    echo "ps aux | grep electron"
else
    echo "âŒ App failed to start. Check the log file:"
    echo "cat $LOG_FILE"
    exit 1
fi
